{% load custom_filters %}
{% load staticfiles %}
<html>

  <head>
    <title> Storefront </title>
    <style>
    table, th, td {
      border: 1px solid black;
      border-collapse: collapse;
    }

    </style>
  </head>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <!--script type="text/javascript" src="{% static "long_poll.js" %}"></script-->
    <script type="text/javascript" src="{% static "jquery.gracefulWebSocket.js" %}"></script>
    <script type="text/javascript">
    $(document).ready( function() {
      window.socket = {};
      socket.ws = $.gracefulWebSocket("ws://localhost:1025/ws");
      socket.send = function (message) {
        socket.ws.send(message);
      }

      socket.ws.onmessage = function (event) {
        // Gets a WS request from Customer/Store
        var messageFromServer = event.data;

        // If WS is from a new customer order
        parsed = JSON.parse(messageFromServer);
        if (parsed['action'] == "order") {
          var storename = parsed['store_name'];
          if (parsed['storename'] == '{{ store_name }}') {
            // Order info
            var orderid = parsed['orderid'];
            var customer = parsed['customer'];
            var custid = parsed['custid'];
            var ordertime = parsed['ordertime'];
            var orderlist = parsed['orderlist'];
            // HTML container
            var html_append = [];
            var rowspan = orderlist.length;
            // First order detail
            html_append.push('<td rowspan=' + rowspan + '">' + orderid + '</td>');
            html_append.push('<td rowspan="' + rowspan + '">' + customer +' (' + custid + ')</  td>');
            html_append.push('<td rowspan="' + rowspan +'">'+ ordertime +'</td>');
            html_append.push('<td>' + orderlist[0]['prodname'] + "</td>");
            html_append.push('<td>' + orderlist[0]['op'] + "</td>");
            html_append.push('<td><form id="complete_order" method="POST"><input type="hidden"  name="details_id" value="'+ orderlist[0]['opid'] + '" /><input type="submit"   value="Complete" name="complete_order" /></form></td>');
            
            // Write to current orders table
            var trappend = document.createElement('tr');
            trappend.innerHTML = html_append.join('');
            $("#orderlist table").append(trappend);

            // Subsequent order details
            for (var i=1; i<rowspan; i++) {
              html_append = []
              html_append.push('<td>' + orderlist[i]['prodname']);
              html_append.push('</td><td>' + orderlist[i]['op'] + '</td>');
              html_append.push('<td><form id="complete_order" method="POST"><input  type="hidden" name="details_id" value="' + orderlist[i]['opid'] + '" /><input type="submit"   value="Complete" name="complete_order" /></form></td>');
              // Write to current orders table
              var trappend = document.createElement('tr');
              trappend.innerHTML = html_append.join('');
              $("#orderlist table").append(trappend);
            };
          };
        };

        var list_element = document.createElement('li');
        list_element.innerHTML = messageFromServer;
        $("#message_list ul").prepend(list_element);
      };

      // All event elements
      var inputbox = document.getElementById("inputbox");
      //var completeButton = document.getElementsByName("complete_order");
  
      /*
      // Complete button event
      for (var i=0; i<completeButton.length; i++) {
        completeButton[i].addEventListener('click', function(e){
          e.preventDefault();
          # hide column
          this.parentNode.parentNode.parentNode.style.display='none';
          window.alert(this.parentNode.parentNode.parentNode);
        }, false);
      };
      */

      inputbox.addEventListener("keydown", function(e) {
        if (!e) { var e = window.event; }
  
        if (e.keyCode == 13) { 
          e.preventDefault(); // sometimes useful
          socket.send(inputbox.value);  
          inputbox.value="";
        }
      }, false);
    });
    </script>

  <body>
    <!-- For testing websocket POST messages 
    <textarea name="term" id="inputbox" cols="40" rows="4"></textarea>
    <div id="message_list">
    <ul>
    </ul>
    </div>
    -->

    <div id="header_block">
      <h2>Storefront for {{ store_name }} (ID:{{ store_id }})</h2>
    </div>  

    <!--======= Order table =======-->
    <div id="orderlist">
      <h3>Current Orders</h3>
      <table>
        <thead>
          <th>Order ID</th>
          <th>Customer (ID)</th>
          <th>Order Time</th>
          <th>Product</th>
          <th>Option</th>
          <th>Status</th>
        </thead>

      {% for order in current_orders %}
      {% with details=order.orderdetail_set.all %}
      {% with rowspan=details|length %}
        <tr>
          <td rowspan="{{ rowspan }}">{{ order.ord_id }}</td>
          <td rowspan="{{ rowspan }}">{{ order.cust.fname }} {{ order.cust.lname }} ({{ order.cust_id }})</td>
          <td rowspan="{{ rowspan }}">{{ order.time }}</td>
          {% if details.0.active %}
          <td>{{ details.0.prod.prod_name }}</td>
          <td>{{ details.0.op.op_name|title }}</td>
          <td><form id="complete_order" method="POST">
          <input type="hidden" name="details_id" value="{{ details.0.id }}" />
          <input type="submit" value="Complete" name="complete_order" />
          </form></td>
          {% else %}
          <td style="display:none"></td>
          <td style="display:none"></td>
          {% endif %}
        </tr>
      <!-- Additional details start -->
      {% for detail in details|slice:"1:" %}
        <tr>
          {% if detail.active %}
          <td>{{ detail.prod.prod_name }}</td>
          <td>{{ detail.op.op_name|title }}</td>
          <td><form id="complete_order" method="POST">
          <input type="hidden" name="details_id" value="{{ detail.id }}" />
          <input type="submit" value="Complete" name="complete_order" />
          </form></td>
          {% else %}
          <td style="display:none"></td>
          <td style="display:none"></td>
          {% endif %}
        </tr>
      {% endfor %}
      <!-- Additional details end -->

      {% endwith %} <!-- rowspan variable end -->
      {% endwith %} <!-- details variable end -->
      {% endfor %}
      </table>
    </div>
    <!--======== Order table end ======= -->

    <!--======== Inventory table ======= -->
    <div id="inventory">
      <h3>Inventory Table</h3>
      <table>
        <thead align="left">
          <th>Status</th>
          <th>Product Name</th>
          <th>Category</th>
          <th>Stock</th>
          <th>Discount</th>
          <th>Options</th>
          <th>Final Price</th>
        </thead>

        {% for inv_row in inventory %}
        <tr>
        {% with options=inv_row.prod.option_set.all %}
        {% with rowspan=options|length %}
          <!-- Status  -->
          <td rowspan="{{ rowspan }}">
            <!-- Active/Inactive toggle -->
            <form id="toggle_active_button" method="POST">
              <input type="hidden" name="prod_id" value="{{ inv_row.prod_id }}" />
              <input type="hidden" name="store_id" value="{{ inv_row.store_id }}" />

              <!-- Button value based on active status -->
              {% with active=inv_row.active %}
              {% if active %}
              <input type="hidden" name="active" value="0" />
              <input type="submit" value="Active" />
              {% else %}
              <input type="hidden" name="active" value="1" />
              <input type="submit" value="Inactive" style="color:red;"/>
              {% endif %}
              {% endwith %}

            </form>
          </td>
          <!-- Status end -->

          <!-- Product Name -->
          <td rowspan="{{ rowspan }}">{{ inv_row.prod.prod_name }}</td>
          <!-- Category -->
          <td rowspan="{{ rowspan }}">{{ inv_row.prod.cat.cat_name }}</td>
          <!-- Stock -->
          <td rowspan="{{ rowspan }}">{{ inv_row.stock }}</td> 
          <!-- Discount -->
          <td rowspan="{{ rowspan }}">{{ inv_row.discount|floatformat:2 }}</td>
          <!-- Options (first row) -->
          <td>{{ options.0.op_name|title }}</td> 
          <td>{{ inv_row.prod.price|add_float:options.0.price|mul_float:inv_row.discount }}</td>
        </tr>

        <!-- Additional options and price start -->
        {% for option in options|slice:"1:" %}
        <tr>
          <td>{{ option.op_name|title }}</td>
          <td>{{ inv_row.prod.price|add_float:option.price|mul_float:inv_row.discount }}
        </tr>
        {% endfor %}
        <!-- Additional options and price end -->
        {% endwith %} <!-- rowspan variable end -->
        {% endwith %} <!-- options variable end -->
        {% endfor %}
      </table>
    </div>
    <!-- ======= Inventory table end ====== -->
  </body>
  
</html>