{% load custom_filters %}
{% load staticfiles %}
<html>
  <head>
    <title> Storefront </title>
    <!--style>
      table, th, td {
        border: 1px solid black;
        border-collapse: collapse;
      }
    </style-->
    <!-- BEGIN GLOBAL MANDATORY STYLES -->
    <link href="http://fonts.googleapis.com/css?family=Open+Sans:400,300,600,700&subset=all" rel="stylesheet" type="text/css"/>
    <link href="{% static "assets/global/plugins/font-awesome/css/font-awesome.min.css"%}" rel="    stylesheet" type="text/css"/>
    <link href="{% static "assets/global/plugins/simple-line-icons/simple-line-icons.min.css"%}" rel="    stylesheet" type="text/css"/>
    <link href="{% static "assets/global/plugins/bootstrap/css/bootstrap.min.css"%}" rel="stylesheet"     type="text/css"/>
    <link href="{% static "assets/global/plugins/uniform/css/uniform.default.css"%}" rel="stylesheet"     type="text/css"/>
    <link href="{% static "assets/global/plugins/bootstrap-switch/css/bootstrap-switch.min.css"%}" rel="    stylesheet" type="text/css"/>
    <!-- END GLOBAL MANDATORY STYLES -->

    <!-- BEGIN THEME STYLES -->
    <link href="{% static "assets/global/css/components-rounded.css"%}" id="style_components" rel="   stylesheet" type="text/css"/>
    <link href="{% static "assets/global/css/plugins.css"%}" rel="stylesheet" type="text/css"/>
    <link href="{% static "assets/admin/layout4/css/layout.css"%}" rel="stylesheet" type="text/css"/>
    <link href="{% static "assets/admin/layout4/css/themes/light.css"%}" rel="stylesheet" type="text/css"    id="style_color"/>
    <link href="{% static "assets/admin/layout4/css/custom.css"%}" rel="stylesheet" type="text/css"/>
    <!-- END THEME STYLES -->

    <!-- BEGIN WEBSOCKET SCRIPTS -->
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <script type="text/javascript" src="{% static "jquery.gracefulWebSocket.js" %}"></script>
    <script type="text/javascript">
    $(document).ready( function() {
      // Define websocket
      window.socket = {};
      socket.ws = $.gracefulWebSocket("ws://localhost:1025/ws");
      socket.send = function (message) {
        socket.ws.send(message);
      }
      socket.ws.onmessage = function (event) {
        // Gets a WS request from Customer/Store
        var messageFromServer = event.data;

        // If WS is from a new customer order
        parsed = JSON.parse(messageFromServer);
        if (parsed['action'] == "order") {
          var storename = parsed['store_name'];
          if (parsed['storename'] == '{{ store_name }}') {

            // Order info
            var orderid = parsed['orderid'];
            var customer = parsed['customer'];
            var custid = parsed['custid'];
            var ordertime = parsed['ordertime'];
            var orderlist = parsed['orderlist'];

            // HTML container
            var html_append = [];
            var rowspan = orderlist.length;

            // First order detail
            html_append.push('<td class="rowsp" rowspan="' + rowspan + '">' + orderid + '</td>');
            html_append.push('<td class="rowsp" rowspan="' + rowspan + '">' + customer +' (' + custid + ')</td>');
            html_append.push('<td class="rowsp" rowspan="' + rowspan +'">'+ ordertime +'</td>');
            html_append.push('<td>' + orderlist[0]['prodname'] + "</td>");
            html_append.push('<td>' + orderlist[0]['op'] + "</td>");
            html_append.push('<td><form id="complete_order" method="POST"><input type="hidden" class="details_id" name="details_id" value="'+ orderlist[0]['opid'] + '" /><input type="submit" style="width:100%" class="btn btn-circle yellow" value="Complete" name="complete_order" /></form></td>');
            
            // Write to current orders table
            var trappend = document.createElement('tr');
            trappend.className = "first-row";
            trappend.innerHTML = html_append.join('');
            $("#orderlist table").append(trappend);

            // Subsequent order details
            for (var i=1; i<rowspan; i++) {
              html_append = []
              html_append.push('<td>' + orderlist[i]['prodname']);
              html_append.push('</td><td>' + orderlist[i]['op'] + '</td>');
              html_append.push('<td><form id="complete_order" method="POST"><input type="hidden" class="details_id" name="details_id" value="' + orderlist[i]['opid'] + '" /><input type="submit" class="btn btn-circle yellow" value="Complete" style="width:100%" name="complete_order" /></form></td>');

              // Write to current orders table
              var trappend = document.createElement('tr');
              trappend.className = "sub-row";
              trappend.innerHTML = html_append.join('');
              $("#orderlist table").append(trappend);
            };
            // Complete button event
            for (var i=0; i<completeButton.length; i++) {
              completeButton[i].addEventListener('click', function(e){
                e.preventDefault();
                //this.parentNode.parentNode.parentNode.style.display='none';
                //$(this).parent().parent().siblings().css({"color":"red","border":"2px solid red"});
      
      
                var current_parent = $(this).parent().parent(); // select parent td
                // Hide appropriate rows when button pressed
                if (current_parent.siblings().length == 5) {
                  // First row of current orders, siblings have rowspan
                  rowspan = current_parent.siblings('.rowsp').attr('rowspan');
                  if (rowspan > 1) {
                    // Hide first product row only
                    current_parent.siblings(':not(.rowsp)').hide();
                    current_parent.hide();
      
                    var subrows = current_parent.parent().nextUntil('.first-row').children(':visible');
                    
                    if (subrows.length) {
                      //subrows.css({"color":"red","border":"2px solid red"});
                    } else {
                      // No subrows left, hide entire row
                      current_parent.parent().hide();
                    }
                  } else {
                    // Hide entire row if it's the only product
                    current_parent.parent().hide();
                  };
                } else if (current_parent.siblings().length == 2) {
                  // Subsequent rows, previous parent children has rowspan
                  current_parent.siblings(':not(.rowsp)').hide();
                  current_parent.hide();
                  // Select all rows relevant to order
                  var prevrows = current_parent.parent().prevUntil('.first-row').andSelf().prev('.first-row').andSelf().nextUntil('.first-row').andSelf();
                  // Hide all rows if all complete
                  if (prevrows.children(':visible').length == 3) { // only order meta visible
                    prevrows.hide();
                  };
                };
      
                // Gather info to send to server
                details_id = $(this).siblings('.details_id').val();
                //alert(details_id);
                // AJAX call to server, update db
                xmlhttp = new XMLHttpRequest();
                xmlhttp.open("POST", "store-{{ store_name }}", true);
                xmlhttp.setRequestHeader("Content-type","application/x-www-form-urlencoded");
                xmlhttp.send("complete_order=Complete&details_id="+details_id);
              }, false);
              
            };
          };
        };

        /*
        // List POST messages, for testing
        var list_element = document.createElement('li');
        list_element.innerHTML = messageFromServer;
        $("#message_list ul").prepend(list_element);
        */
      };

      // All event elements
      var inputbox = document.getElementById("inputbox");
      var completeButton = document.getElementsByName("complete_order");
  
      
      // Complete button event
      for (var i=0; i<completeButton.length; i++) {
        completeButton[i].addEventListener('click', function(e){
          e.preventDefault();
          //this.parentNode.parentNode.parentNode.style.display='none';
          //$(this).parent().parent().siblings().css({"color":"red","border":"2px solid red"});


          var current_parent = $(this).parent().parent(); // select parent td
          // Hide appropriate rows when button pressed
          if (current_parent.siblings().length == 5) {
            // First row of current orders, siblings have rowspan
            rowspan = current_parent.siblings('.rowsp').attr('rowspan');
            if (rowspan > 1) {
              // Hide first product row only
              current_parent.siblings(':not(.rowsp)').hide();
              current_parent.hide();

              var subrows = current_parent.parent().nextUntil('.first-row').children(':visible');

              if (subrows.length) {
                //subrows.css({"color":"red","border":"2px solid red"});
              } else {
                // No subrows left, hide entire row
                current_parent.parent().hide();
              }
            } else {
              // Hide entire row if it's the only product
              current_parent.parent().hide();
            };
          } else if (current_parent.siblings().length == 2) {
            // Subsequent rows, previous parent children has rowspan
            current_parent.siblings(':not(.rowsp)').hide();
            current_parent.hide();
            // Select all rows relevant to order
            var prevrows = current_parent.parent().prevUntil('.first-row').andSelf().prev('.first-row').andSelf().nextUntil('.first-row').andSelf();
            // Hide all rows if all complete
            if (prevrows.children(':visible').length == 3) { // only order meta visible
              prevrows.hide();
            };
          };

          // Gather info to send to server
          details_id = $(this).siblings('.details_id').val();
          //alert(details_id);
          // AJAX call to server, update db
          xmlhttp = new XMLHttpRequest();
          xmlhttp.open("POST", "store-{{ store_name }}", true);
          xmlhttp.setRequestHeader("Content-type","application/x-www-form-urlencoded");
          xmlhttp.send("complete_order=Complete&details_id="+details_id);
        }, false);
        
      };
      
      /* 
      // Input field for testing
      inputbox.addEventListener("keydown", function(e) {
        if (!e) { var e = window.event; }
  
        if (e.keyCode == 13) {  // enter key listener
          e.preventDefault();
          socket.send(inputbox.value);  
          inputbox.value="";
        }
      }, false);
      */
    });
    </script>
    <!-- END WEBSOCKET SCRIPTS -->
  </head>

  <body>
    <!-- For testing websocket POST messages 
    <textarea name="term" id="inputbox" cols="40" rows="4"></textarea>
    <div id="message_list">
    <ul>
    </ul>
    </div>
    -->
    <div class="page-content-wrapper">
    <div class="page-head col-sm-12">
    <div class="page-title">
      <h1>Storefront: {{ store_name }} <small>(Store ID:{{ store_id }})</small></h1>
    </div>
    </div>
    

    <!-- BEGIN CURRENT ORDERS-->
    <div class="col-sm-12">
    <div class="portlet box yellow">
      <div class="portlet-title">
        <div class="caption">
          Current Orders
        </div>
      </div>
      <div class="portlet-body">
        <div id="orderlist" class="table-scrollable">
          <table class="table table-condensed table-hover">
          <thead>
          <tr class="uppercase">
            <th>
               ORDER ID
            </th>
            <th>
               CUSTOMER (ID)
            </th>
            <th>
               ORDER TIME
            </th>
            <th>
               PRODUCT
            </th>
            <th>
               OPTION
            </th>
            <th>
               STATUS
            </th>
          </tr>
          </thead>
          <tbody>
          {% for order in current_orders %}
          {% with details=order.orderdetail_set.all %}
          {% with rowspan=details|length %}
          <tr class="first-row">
            <td class="rowsp" rowspan="{{ rowspan }}">{{ order.ord_id }}</td>
            <td class="rowsp" rowspan="{{ rowspan }}">{{ order.cust.fname }} {{ order.cust.lname }} <small>({{ order.cust_id }})</small></td>
            <td class="rowsp" rowspan="{{ rowspan }}">{{ order.time|date:'g:i A' }}</td>
            {% if details.0.active %}
            <td>{{ details.0.prod.prod_name }}</td>
            <td>{{ details.0.op.op_name|title }}</td>
            <td><form id="complete_order" method="POST" style="margin-bottom:0px">
            <input type="hidden" class="details_id" name="details_id" value="{{ details.0.id }}" />
            <input type="submit" value="Complete" class="btn btn-circle yellow" style="width:100%" name="complete_order"/>
            </form></td>
            {% else %}
            <td style="display:none"></td>
            <td style="display:none"></td>
            <td style="display:none"></td>
            {% endif %}
          </tr>
          <!-- Additional details start -->
          {% for detail in details|slice:"1:" %}
          <tr class="sub-row">
            {% if detail.active %}
            <td>{{ detail.prod.prod_name }}</td>
            <td>{{ detail.op.op_name|title }}</td>
            <td><form id="complete_order" method="POST" style="margin-bottom:0px">
            <input type="hidden" class="details_id" name="details_id" value="{{ detail.id }}" />
            <input type="submit" value="Complete" class="btn btn-circle yellow" style="width:100%" name="complete_order"/>
            </form></td>
            {% else %}
            <td style="display:none"></td>
            <td style="display:none"></td>
            <td style="display:none"></td>
            {% endif %}
          </tr>
          {% endfor %}
          <!-- Additional details end -->
          {% endwith %} <!-- rowspan variable end -->
          {% endwith %} <!-- details variable end -->
          {% endfor %}
          </tbody>
          </table>
        </div>
      </div>
    </div>
    </div>
    <!-- END CURRENT ORDERS -->

    <!-- BEGIN INVENTORY TABLE -->
    <div class="col-sm-12">
    <div class="portlet box blue">
      <div class="portlet-title">
        <div class="caption">
          Inventory
        </div>
      </div>
      <div class="portlet-body">
        <div class="table-scrollable">
          <table class="table table-condensed table-hover">
          <thead>
          <tr>
            <th>
               PRODUCT NAME
            </th>
            <th>
               CATEGORY
            </th>
            <th>
               DISCOUNT
            </th>
            <th>
               OPTIONS
            </th>
            <th>
               FINAL PRICE
            </th>
            <th>
               STATUS
            </th>
          </tr>
          </thead>
          <tbody>
          {% for inv_row in inventory %}
          <tr>
          {% with options=inv_row.prod.option_set.all %}
          {% with rowspan=options|length %}
            
  
            <!-- Product Name -->
            <td rowspan="{{ rowspan }}">{{ inv_row.prod.prod_name }}</td>
            <!-- Category -->
            <td rowspan="{{ rowspan }}">{{ inv_row.prod.cat.cat_name|title }}</td>
            <!-- Stock -->
            <!--td rowspan="{{ rowspan }}">{{ inv_row.stock }}</td--> 
            <!-- Discount -->
            <td rowspan="{{ rowspan }}">{{ inv_row.discount|floatformat:2 }}</td>
            <!-- Options (first row) -->
            <td >{{ options.0.op_name|title }}</td> 
            <td>{{ inv_row.prod.price|add_float:options.0.price|mul_float:inv_row.discount }}</td>
            <!-- Status  -->
            <td rowspan="{{ rowspan }}">
              <!-- Active/Inactive toggle -->
              <form id="toggle_active_button" method="POST" style="margin-bottom:0px">
                <input type="hidden" name="prod_id" value="{{ inv_row.prod_id }}" />
                <input type="hidden" name="store_id" value="{{ inv_row.store_id }}" />
  
                <!-- Button value based on active status -->
                {% with active=inv_row.active %}
                {% if active %}
                <input type="hidden" name="active" value="0" />
                <input type="submit" class="btn btn-circle btn-info" value="Active" style="width:100%"/>
                {% else %}
                <input type="hidden" name="active" value="1" />
                <input type="submit" class="btn btn-circle btn-danger" value="Inactive" style="width:100%"/>
                {% endif %}
                {% endwith %}
  
              </form>
            </td>
            <!-- Status end -->
          </tr>
  
          <!-- Additional options and price start -->
          {% for option in options|slice:"1:" %}
          <tr>
            <td>{{ option.op_name|title }}</td>
            <td>{{ inv_row.prod.price|add_float:option.price|mul_float:inv_row.discount }}</td>
          </tr>
          {% endfor %}
          <!-- Additional options and price end -->
          {% endwith %} <!-- rowspan variable end -->
          {% endwith %} <!-- options variable end -->
          {% endfor %}
          </tbody>
          </table>
        </div>
      </div>
    </div>
    </div>
    <!-- END INVENTORY TABLE -->




  </div> <!-- wrapper -->
  </body>
  
</html>