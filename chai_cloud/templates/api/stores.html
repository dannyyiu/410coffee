{% load custom_filters %}
<html>

  <head>
    <title> Storefront </title>
    <style>
    table, th, td {
      border: 1px solid black;
      border-collapse: collapse;
    }

    </style>
  </head>

  <body>

    <div id="header_block">
      <h2>Storefront for {{ store_name }} (ID:{{ store_id }})</h2>
    </div> 

    <!--======= Order table =======-->
    <div id="orderlist">
      <h3>Current Orders</h3>
      <table>
        <thead>
          <th>Order ID</th>
          <th>Customer (ID)</th>
          <th>Order Time</th>
          <th>Product</th>
          <th>Option</th>
          <th>Status</th>
        </thead>

      {% for order in current_orders %}
      {% with details=order.orderdetail_set.all %}
      {% with rowspan=details|length %}
        <tr>
          <td rowspan="{{ rowspan }}">{{ order.ord_id }}</td>
          <td rowspan="{{ rowspan }}">{{ order.cust.fname }} {{ order.cust.lname }} ({{ order.cust_id }})</td>
          <td rowspan="{{ rowspan }}">{{ order.time }}</td>
          {% if details.0.active %}
          <td>{{ details.0.prod.prod_name }}</td>
          <td>{{ details.0.op.op_name }}</td>
          <td><form id="complete_order" method="POST">
          <input type="hidden" name="details_id" value="{{ details.0.id }}" />
          <input type="submit" value="Complete" name="complete_order" />
          </form></td>
          {% else %}
          <td></td>
          <td></td>
          {% endif %}
        </tr>
      <!-- Additional details start -->
      {% for detail in details|slice:"1:" %}
        <tr>
          {% if detail.active %}
          <td>{{ detail.prod.prod_name }}</td>
          <td>{{ detail.op.op_name }}</td>
          <td><form id="complete_order" method="POST">
          <input type="hidden" name="details_id" value="{{ detail.id }}" />
          <input type="submit" value="Complete" name="complete_order" />
          </form></td>
          {% else %}
          <td></td>
          <td></td>
          {% endif %}
        </tr>
      {% endfor %}
      <!-- Additional details end -->

      {% endwith %} <!-- rowspan variable end -->
      {% endwith %} <!-- details variable end -->
      {% endfor %}
      </table>
    </div>
    <!--======== Order table end ======= -->
    <!--======== Inventory table ======= -->
    <div id="inventory">
      <h3>Inventory Table</h3>
      <table>
        <thead align="left">
          <th>Status</th>
          <th>Product Name</th>
          <th>Category</th>
          <th>Stock</th>
          <th>Discount</th>
          <th>Options</th>
          <th>Final Price</th>
        </thead>

        {% for inv_row in inventory %}
        <tr>
        {% with options=inv_row.prod.option_set.all %}
        {% with rowspan=options|length %}
          <!-- Status  -->
          <td rowspan="{{ rowspan }}">
            <!-- Active/Inactive toggle -->
            <form id="toggle_active_button" method="POST">
              <input type="hidden" name="prod_id" value="{{ inv_row.prod_id }}" />
              <input type="hidden" name="store_id" value="{{ inv_row.store_id }}" />

              <!-- Button value based on active status -->
              {% with active=inv_row.active %}
              {% if active %}
              <input type="hidden" name="active" value="0" />
              <input type="submit" value="Active" />
              {% else %}
              <input type="hidden" name="active" value="1" />
              <input type="submit" value="Inactive" style="color:red;"/>
              {% endif %}
              {% endwith %}

            </form>
          </td>
          <!-- Status end -->

          <!-- Product Name -->
          <td rowspan="{{ rowspan }}">{{ inv_row.prod.prod_name }}</td>
          <!-- Category -->
          <td rowspan="{{ rowspan }}">{{ inv_row.prod.cat.cat_name }}</td>
          <!-- Stock -->
          <td rowspan="{{ rowspan }}">{{ inv_row.stock }}</td> 
          <!-- Discount -->
          <td rowspan="{{ rowspan }}">{{ inv_row.discount|floatformat:2 }}</td>
          <!-- Options (first row) -->
          <td>{{ options.0.op_name }}</td> 
          <td>{{ inv_row.prod.price|add_float:options.0.price|mul_float:inv_row.discount }}</td>
        </tr>

        <!-- Additional options and price start -->
        {% for option in options|slice:"1:" %}
        <tr>
          <td>{{ option.op_name }}</td>
          <td>{{ inv_row.prod.price|add_float:option.price|mul_float:inv_row.discount }}
        </tr>
        {% endfor %}
        <!-- Additional options and price end -->
        {% endwith %} <!-- rowspan variable end -->
        {% endwith %} <!-- options variable end -->
        {% endfor %}
      </table>
    </div>
    <!-- ======= Inventory table end ====== -->
  </body>
  
</html>